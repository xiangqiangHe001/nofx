# 自定义与外部仓库适配工作流

本章节规定了在不合并外部仓库代码、不影响现有逻辑与功能的前提下，进行“选择性适配”的标准提示词模板与实施流程。所有新增能力必须 behind flag（默认关闭）。

## 目标
- 对比外部仓库（如 `https://github.com/NoFxAiOS/nofx.git` 的 `dev` 分支）更新点，选择性适配到本地项目。
- 不合并外部仓库结构，不复制大段代码；默认行为不变，改动可回滚。

## 适配范围与非目标
- 范围：API 扩展、配置新增、Trader/Decision 增强、前端可视化增强、部署优化。
- 非目标：重构现有架构、修改现有 API 返回字段、改变默认配置或日志格式。

## 关键约束
- 新增能力必须 behind flag：`config.Config.ExternalCompat`（总开关与模块级开关），全部默认关闭。
- 只做“最小必要改动”，保持命名风格与目录结构一致。
- 依赖升级仅在完全兼容时进行，并提供回滚方案。

## 输入材料
- 外部仓库地址、分支或标签；具体 Diff（文件与 hunk）。
- 目标功能列表与对应模块路径（后端/前端/部署）。

## 输出格式
- 仅针对本地项目产出补丁（文件路径 + 修改块），附带：目的、影响范围、开关说明、验证与回滚。

## 实施步骤
1) 列出外部更新点，建立与本地模块的映射关系。
2) 逐点评估“采纳/不采纳”，给出依据与影响评估。
3) 对采纳项：设计 behind-flag 适配方案（接口保持、结构兼容、默认关闭）。
4) 产出补丁与更新文档，执行编译与冒烟验证。
5) 在开关开启与关闭两种状态下进行 A/B 验证。

## 验证与回滚
- 后端：`GET /health` 应返回 `ok`；核心接口（`/api/account` 等）在关闭开关时响应不变。
- 前端：默认 UI 无变化；开启 `external_compat_web=true` 时才呈现新增元素。
- 回滚：删除扩展点/关闭开关即可恢复原状；提交应分组且易于回退。

## 提示词模板（可直接使用）
背景：
- 本地项目位于 `D:\TRAE\projerct`（Go 后端 + Vite 前端）。
- 外部仓库：`https://github.com/NoFxAiOS/nofx.git`，默认使用 `dev` 分支。

目标：
- 选择性适配 `dev` 分支的更新点；默认行为不变，不影响现有逻辑与功能。

约束：
- 禁止合并外部仓库结构或复制大段代码。
- 所有新增能力 behind flag，默认关闭；不改变已有 API、配置默认值、日志格式。

输入材料：
- 指定外部分支/标签与精确 Diff；列出目标功能与模块路径。

输出要求：
- 提供本地补丁与变更说明、开关配置、验证步骤与回滚方案。

实施步骤：
- 列出更新点→映射模块→评估采纳→设计 behind-flag 适配→产出补丁→验证。

验证：
- 编译与健康检查；核心接口 A/B 验证（开关关闭/开启）。

回滚：
- 关闭开关或删除扩展点；保留提交分组以支持快速回退。
